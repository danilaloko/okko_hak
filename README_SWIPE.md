# Okko Discovery - Система свайпов

## Описание

Система свайпов для изучения предпочтений пользователей и предоставления персонализированных рекомендаций фильмов. Работает аналогично окконатору, но с двумя кнопками (лайк/дизлайк) и отдельным микросервисом.

## Архитектура

### Микросервисы
- **Основное приложение** (порт 5000): Flask приложение с веб-интерфейсом
- **Окконатор** (порт 5001): Микросервис для обработки вопросов и рекомендаций
- **Свайпы** (порт 5002): Микросервис для обработки свайпов и изучения предпочтений

### Компоненты
- `swipe_service.py` - Микросервис для обработки свайпов
- `static/js/swipe.js` - JavaScript для интерфейса свайпов
- `templates/swipe.html` - HTML шаблон для страницы свайпов
- `start_swipe_service.sh` - Скрипт запуска микросервиса свайпов
- `stop_swipe_service.sh` - Скрипт остановки микросервиса свайпов

## Запуск системы

### 1. Запуск основного приложения
```bash
python app.py
```

### 2. Запуск микросервиса Окконатора
```bash
./start_okkonator_service.sh
```

### 3. Запуск микросервиса свайпов
```bash
./start_swipe_service.sh
```

### 4. Остановка сервисов
```bash
./stop_okkonator_service.sh
./stop_swipe_service.sh
```

## API свайпов

### Создание сессии
```http
POST http://localhost:5002/api/swipe/start
Content-Type: application/json

{
    "batch_size": 20
}
```

### Обработка свайпа
```http
POST http://localhost:5002/api/swipe/action
Content-Type: application/json

{
    "session_id": "session_123",
    "movie_id": 1,
    "action": "like"  // или "dislike"
}
```

### Получение рекомендаций
```http
POST http://localhost:5002/api/swipe/recommendations
Content-Type: application/json

{
    "session_id": "session_123",
    "top_k": 6
}
```

## Логика работы

### Алгоритм изучения предпочтений
1. **Инициализация**: Создается нулевой вектор пользователя
2. **Свайпы**: Пользователь свайпает фильмы влево (дизлайк) или вправо (лайк)
3. **Обновление вектора**: При лайке вектор фильма добавляется к вектору пользователя, при дизлайке - вычитается
4. **Нормализация**: Вектор пользователя нормализуется после каждого обновления
5. **Рекомендации**: Система находит фильмы с наибольшим косинусным сходством к вектору пользователя

### Векторная модель
- **Размерность**: 384 (sentence-transformers/all-MiniLM-L6-v2)
- **Содержание**: Семантическое представление названия, описания и жанра фильма
- **Обновление**: `user_vector = user_vector + weight * movie_vector`
- **Вес**: +0.1 для лайков, -0.1 для дизлайков
- **Нормализация**: Вектор нормализуется после каждого обновления

### Преимущества векторного подхода
- **Простота**: Не нужно вычислять отдельные характеристики
- **Семантика**: Учитывает смысловое содержание фильмов
- **Эффективность**: Использует готовые эмбеддинги из БД
- **Точность**: Косинусное сходство дает более точные рекомендации

## Интерфейс

### Страница свайпов (`/swipe`)
- Карточки фильмов с постером, названием, годом, жанром, рейтингом
- Кнопки "Да" (лайк) и "Нет" (дизлайк)
- Кнопка информации о фильме
- Прогресс-бар с количеством свайпов
- Touch-события для свайпов на мобильных устройствах

### Страница результатов (`/results`)
- Показывает рекомендации на основе свайпов
- Отображает профиль пользователя
- Объясняет причины рекомендаций

## Интеграция с основным приложением

### Главная страница
- Добавлены карточки методов получения рекомендаций
- Кнопки для перехода к окконатору и свайпам
- Стилизованные карточки с иконками и описаниями

### Навигация
- `/okkonator` - Окконатор (вопросы)
- `/swipe` - Свайпы
- `/results` - Результаты (общие для обоих методов)

## Технические детали

### Зависимости
- Flask
- pandas
- numpy
- sentence-transformers (опционально)
- scikit-learn

### Данные
- Использует ту же базу данных фильмов, что и окконатор
- Поддерживает как предварительно созданную векторную БД, так и загрузку из CSV

### Производительность
- Кэширование сессий пользователей
- Асинхронная обработка свайпов
- Оптимизированные запросы к базе данных

## Мониторинг

### Проверка здоровья сервисов
```bash
curl http://localhost:5001/health  # Окконатор
curl http://localhost:5002/health  # Свайпы
```

### Отладка характеристик фильмов
```bash
# Просмотр характеристик конкретного фильма
curl http://localhost:5002/api/swipe/debug/movie/1

# Просмотр информации о сессии
curl http://localhost:5002/api/swipe/session/session_123
```

### Тестирование в браузере
```javascript
// В консоли браузера на странице свайпов
testMovieFeatures(1);  // Показать характеристики фильма с ID 1
```

### Логи
- Все сервисы выводят подробные логи в консоль
- Отслеживание ошибок и производительности
- Мониторинг активных сессий

## Разработка

### Добавление новых характеристик
1. Обновить список `AXES` в `okkonator.py`
2. Добавить логику обновления профиля в `swipe_service.py`
3. Обновить интерфейс для отображения новых характеристик

### Настройка алгоритма
- Изменить веса обновления профиля в `update_theta_from_movie()`
- Настроить количество свайпов для обучения
- Добавить дополнительные фильтры и бонусы

## Безопасность

- CORS настроен для всех сервисов
- Валидация входных данных
- Ограничение размера сессий
- Защита от переполнения памяти
