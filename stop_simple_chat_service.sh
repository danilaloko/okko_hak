#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ—Å—Ç–æ–≥–æ —á–∞—Ç —Å–µ—Ä–≤–∏—Å–∞

echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Å—Ç–æ–≥–æ —á–∞—Ç —Å–µ—Ä–≤–∏—Å–∞..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ PID —Ñ–∞–π–ª–∞
if [ -f "simple_chat_service.pid" ]; then
    PID=$(cat simple_chat_service.pid)
    
    if ps -p $PID > /dev/null; then
        echo "üîç –ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å —Å PID: $PID"
        echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å..."
        
        # –ü—ã—Ç–∞–µ–º—Å—è –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å gracefully
        kill $PID
        
        # –ñ–¥–µ–º 5 —Å–µ–∫—É–Ω–¥
        sleep 5
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
        if ps -p $PID > /dev/null; then
            echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª—Å—è gracefully, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º..."
            kill -9 $PID
            sleep 2
        fi
        
        # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
        if ps -p $PID > /dev/null; then
            echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å"
            exit 1
        else
            echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        fi
    else
        echo "‚ö†Ô∏è  –ü—Ä–æ—Ü–µ—Å—Å —Å PID $PID –Ω–µ –Ω–∞–π–¥–µ–Ω"
    fi
    
    # –£–¥–∞–ª—è–µ–º PID —Ñ–∞–π–ª
    rm simple_chat_service.pid
    echo "üóëÔ∏è  PID —Ñ–∞–π–ª —É–¥–∞–ª–µ–Ω"
else
    echo "‚ö†Ô∏è  PID —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø–æ –∏–º–µ–Ω–∏..."
    
    # –ò—â–µ–º –ø—Ä–æ—Ü–µ—Å—Å –ø–æ –∏–º–µ–Ω–∏
    PIDS=$(pgrep -f "simple_chat_service.py")
    
    if [ -n "$PIDS" ]; then
        echo "üîç –ù–∞–π–¥–µ–Ω—ã –ø—Ä–æ—Ü–µ—Å—Å—ã: $PIDS"
        echo "‚èπÔ∏è  –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã..."
        
        for pid in $PIDS; do
            kill $pid
        done
        
        sleep 3
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å—ã
        REMAINING_PIDS=$(pgrep -f "simple_chat_service.py")
        if [ -n "$REMAINING_PIDS" ]; then
            echo "‚ö†Ô∏è  –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≤–µ—Ä—à–∞–µ–º..."
            for pid in $REMAINING_PIDS; do
                kill -9 $pid
            done
        fi
        
        echo "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    else
        echo "‚ÑπÔ∏è  –ü—Ä–æ—Ü–µ—Å—Å—ã —Å–µ—Ä–≤–∏—Å–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    fi
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ—Ä—Ç 5004 —Å–≤–æ–±–æ–¥–µ–Ω
if lsof -Pi :5004 -sTCP:LISTEN -t >/dev/null ; then
    echo "‚ö†Ô∏è  –ü–æ—Ä—Ç 5004 –≤—Å–µ –µ—â–µ –∑–∞–Ω—è—Ç"
    echo "üîç –ü—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 5004:"
    lsof -Pi :5004 -sTCP:LISTEN
else
    echo "‚úÖ –ü–æ—Ä—Ç 5004 —Å–≤–æ–±–æ–¥–µ–Ω"
fi

echo ""
echo "üí¨ –ü—Ä–æ—Å—Ç–æ–π —á–∞—Ç —Å–µ—Ä–≤–∏—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
echo "üìã –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: logs/simple_chat_service.log"
